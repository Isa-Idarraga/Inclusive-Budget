{% extends "base.html" %}
{% load static humanize %}

{% block content %}
<div class="project-detail-bg py-5">
  <div class="container">
    
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="display-5 fw-bold m-0">{{ project.name }}</h1>
        <p class="text-muted mb-0">Análisis Gráfico de Presupuesto vs Gasto Real</p>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-success" href="{% url 'projects:listar_consumos_proyecto' project.id %}">
          <i class="fas fa-chart-line me-1"></i>Ver consumos
        </a>
        <a class="btn btn-outline-secondary" href="{% url 'projects:project_detail' project.id %}">
          <i class="fas fa-arrow-left me-1"></i>Volver
        </a>
      </div>
    </div>

    <!-- Resumen de presupuesto -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="p-3 bg-white rounded-4 shadow-sm">
          <div class="text-muted small">Presupuesto inicial</div>
          <div class="fs-4 fw-semibold text-success">
            ${{ project.presupuesto|floatformat:0|intcomma }}
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="p-3 bg-white rounded-4 shadow-sm">
          <div class="text-muted small">Presupuesto gastado</div>
          <div class="fs-4 fw-semibold text-danger">
            ${{ project.presupuesto_gastado_calculado|floatformat:0|intcomma }}
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="p-3 bg-white rounded-4 shadow-sm">
          <div class="text-muted small">Presupuesto disponible</div>
          <div class="fs-4 fw-semibold text-warning">
            ${{ project.presupuesto_actual|floatformat:0|intcomma }}
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="p-3 bg-white rounded-4 shadow-sm">
          <div class="text-muted small">Desviación total</div>
          <div class="fs-4 fw-semibold" id="desviacion-total">
            <span class="text-muted">Calculando...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Selector de período -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="p-3 bg-white rounded-4 shadow-sm">
          <div class="row align-items-center">
            <div class="col-md-6">
              <label class="form-label mb-2 fw-semibold">
                <i class="fas fa-calendar-alt me-2"></i>Período de análisis
              </label>
              <select class="form-select" id="periodo-select">
                <option value="todo">Todo el proyecto</option>
                <option value="mes">Último mes</option>
                <option value="trimestre">Último trimestre</option>
                <option value="custom">Personalizado</option>
              </select>
            </div>
            <div class="col-md-6" id="custom-dates" style="display: none;">
              <div class="row">
                <div class="col-6">
                  <label class="form-label small">Desde</label>
                  <input type="date" class="form-control" id="fecha-desde">
                </div>
                <div class="col-6">
                  <label class="form-label small">Hasta</label>
                  <input type="date" class="form-control" id="fecha-hasta">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráfico consolidado general -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="p-4 bg-white rounded-4 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0">
              <i class="fas fa-chart-bar me-2"></i>Comparativa General: Presupuesto vs Gasto Real
            </h5>
          </div>
          <canvas id="grafico-consolidado" height="80"></canvas>
        </div>
      </div>
    </div>

    <!-- Gráfico por materiales -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="p-4 bg-white rounded-4 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0">
              <i class="fas fa-layer-group me-2"></i>Comparativa por Material
            </h5>
          </div>
          <canvas id="grafico-materiales" height="120"></canvas>
        </div>
      </div>
    </div>

    <!-- Alertas de sobrecosto -->
    <div class="row mb-4" id="alertas-container" style="display: none;">
      <div class="col-12">
        <div class="p-4 bg-danger bg-opacity-10 border border-danger rounded-4">
          <h5 class="fw-bold text-danger mb-3">
            <i class="fas fa-exclamation-triangle me-2"></i>Alertas de Sobrecosto
          </h5>
          <div id="alertas-lista"></div>
        </div>
      </div>
    </div>

    <!-- Gráfico de evolución temporal -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="p-4 bg-white rounded-4 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0">
              <i class="fas fa-chart-line me-2"></i>Evolución Temporal del Gasto
            </h5>
          </div>
          <canvas id="grafico-evolucion" height="80"></canvas>
          <div class="mt-3 p-3 bg-light rounded">
            <div class="row text-center">
              <div class="col-md-4">
                <small class="text-muted d-block">Ritmo de gasto promedio</small>
                <span class="fw-bold fs-5" id="ritmo-gasto">-</span>
              </div>
              <div class="col-md-4">
                <small class="text-muted d-block">Proyección de finalización</small>
                <span class="fw-bold fs-5" id="proyeccion-fecha">-</span>
              </div>
              <div class="col-md-4">
                <small class="text-muted d-block">Presupuesto proyectado</small>
                <span class="fw-bold fs-5" id="proyeccion-presupuesto">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de detalles -->
    <div class="row">
      <div class="col-12">
        <div class="p-4 bg-white rounded-4 shadow-sm">
          <h5 class="fw-bold mb-3">
            <i class="fas fa-table me-2"></i>Detalle por Material
          </h5>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Material</th>
                  <th class="text-end">Presupuesto</th>
                  <th class="text-end">Gasto Real</th>
                  <th class="text-end">Diferencia</th>
                  <th class="text-center">Desviación</th>
                  <th class="text-center">Estado</th>
                </tr>
              </thead>
              <tbody id="tabla-body">
                <tr>
                  <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin me-2"></i>Cargando datos...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
let graficoConsolidado, graficoMateriales, graficoEvolucion;
let datosOriginales = null;
let ordenadoPorDesviacion = false;

const COLORES = {
  presupuesto: 'rgba(34, 139, 34, 0.7)',
  presupuestoBorde: 'rgba(34, 139, 34, 1)',
  gasto: 'rgba(220, 53, 69, 0.7)',
  gastoBorde: 'rgba(220, 53, 69, 1)',
  linea: 'rgba(13, 110, 253, 0.7)',
  lineaBorde: 'rgba(13, 110, 253, 1)'
};

document.addEventListener('DOMContentLoaded', function() {
  cargarDatos();
  
  document.getElementById('periodo-select').addEventListener('change', function(e) {
    if (e.target.value === 'custom') {
      document.getElementById('custom-dates').style.display = 'block';
    } else {
      document.getElementById('custom-dates').style.display = 'none';
      cargarDatos();
    }
  });
});

async function cargarDatos() {
  try {
    const periodo = document.getElementById('periodo-select').value;
    let url = `{%url 'projects:api_datos_graficos' project.id %}?periodo=${periodo}`;
    
    console.log('Cargando datos desde:', url);
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const datos = await response.json();
    console.log('Datos recibidos:', datos);
    
    datosOriginales = datos;
    actualizarGraficoConsolidado(datos.consolidado);
    actualizarGraficoMateriales(datos.por_material);
    actualizarGraficoEvolucion(datos.evolucion_temporal);
    actualizarTablaDetalles(datos);
    verificarAlertas(datos);
    calcularProyecciones(datos);
    
  } catch (error) {
    console.error('Error:', error);
    document.getElementById('tabla-body').innerHTML = `
      <tr><td colspan="6" class="text-center text-danger py-4">
        <i class="fas fa-exclamation-triangle me-2"></i>Error: ${error.message}
      </td></tr>
    `;
  }
}

function actualizarGraficoConsolidado(datos) {
  const ctx = document.getElementById('grafico-consolidado');
  if (graficoConsolidado) graficoConsolidado.destroy();
  
  const desviacion = datos.presupuesto > 0 
    ? ((datos.gasto_real - datos.presupuesto) / datos.presupuesto * 100).toFixed(1)
    : 0;
  
  document.getElementById('desviacion-total').innerHTML = 
    `<span class="${desviacion > 0 ? 'text-danger' : 'text-success'}">${desviacion > 0 ? '+' : ''}${desviacion}%</span>`;
  
  graficoConsolidado = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Consolidado General'],
      datasets: [{
        label: 'Presupuesto',
        data: [datos.presupuesto],
        backgroundColor: COLORES.presupuesto,
        borderColor: COLORES.presupuestoBorde,
        borderWidth: 2
      }, {
        label: 'Gasto Real',
        data: [datos.gasto_real],
        backgroundColor: datos.gasto_real > datos.presupuesto ? COLORES.gasto : COLORES.presupuesto,
        borderColor: datos.gasto_real > datos.presupuesto ? COLORES.gastoBorde : COLORES.presupuestoBorde,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.dataset.label}: $${Math.round(ctx.parsed.y).toLocaleString('es-CO')}`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: v => '$' + Math.round(v).toLocaleString('es-CO')
          }
        }
      }
    }
  });
}

function actualizarGraficoMateriales(datos) {
  const ctx = document.getElementById('grafico-materiales');
  if (graficoMateriales) graficoMateriales.destroy();
  
  if (!datos || datos.length === 0) {
    const context = ctx.getContext('2d');
    context.font = '16px Arial';
    context.fillStyle = '#6c757d';
    context.textAlign = 'center';
    context.fillText('No hay datos', ctx.width / 2, ctx.height / 2);
    return;
  }
  
  graficoMateriales = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: datos.map(d => d.material),
      datasets: [{
        label: 'Presupuesto',
        data: datos.map(d => d.presupuesto),
        backgroundColor: COLORES.presupuesto,
        borderWidth: 2
      }, {
        label: 'Gasto Real',
        data: datos.map(d => d.gasto_real),
        backgroundColor: COLORES.gasto,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: v => '$' + Math.round(v).toLocaleString('es-CO')
          }
        }
      }
    }
  });
}

function actualizarGraficoEvolucion(datos) {
  const ctx = document.getElementById('grafico-evolucion');
  if (graficoEvolucion) graficoEvolucion.destroy();
  
  if (!datos || datos.length === 0) return;
  
  graficoEvolucion = new Chart(ctx, {
    type: 'line',
    data: {
      labels: datos.map(d => d.fecha),
      datasets: [{
        label: 'Gasto Acumulado',
        data: datos.map(d => d.gasto_acumulado),
        borderColor: COLORES.lineaBorde,
        backgroundColor: COLORES.linea,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: v => '$' + Math.round(v).toLocaleString('es-CO')
          }
        }
      }
    }
  });
}

function actualizarTablaDetalles(datos) {
  const tbody = document.getElementById('tabla-body');
  if (!datos.por_material || datos.por_material.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No hay datos</td></tr>';
    return;
  }
  
  tbody.innerHTML = datos.por_material.map(item => {
    const desv = item.presupuesto > 0 ? ((item.gasto_real - item.presupuesto) / item.presupuesto * 100).toFixed(1) : 0;
    const dif = item.gasto_real - item.presupuesto;
    return `
      <tr>
        <td>${item.material}</td>
        <td class="text-end">$${Math.round(item.presupuesto).toLocaleString('es-CO')}</td>
        <td class="text-end">$${Math.round(item.gasto_real).toLocaleString('es-CO')}</td>
        <td class="text-end ${dif > 0 ? 'text-danger' : 'text-success'}">
          ${dif > 0 ? '+' : ''}$${Math.round(Math.abs(dif)).toLocaleString('es-CO')}
        </td>
        <td class="text-center">
          <span class="badge bg-${desv > 0 ? 'danger' : 'success'}">${desv > 0 ? '+' : ''}${desv}%</span>
        </td>
        <td class="text-center">
          <span class="badge bg-${item.gasto_real > item.presupuesto ? 'danger' : 'success'}">
            ${item.gasto_real > item.presupuesto ? 'Sobrecosto' : 'OK'}
          </span>
        </td>
      </tr>
    `;
  }).join('');
}

function verificarAlertas(datos) {
  const container = document.getElementById('alertas-container');
  const lista = document.getElementById('alertas-lista');
  const alertas = datos.por_material.filter(m => m.gasto_real > m.presupuesto);
  
  if (alertas.length > 0) {
    container.style.display = 'block';
    lista.innerHTML = alertas.map(m => `
      <div class="alert alert-danger mb-2">
        <strong>${m.material}</strong> excedió el presupuesto en 
        $${Math.round(m.gasto_real - m.presupuesto).toLocaleString('es-CO')}
      </div>
    `).join('');
  } else {
    container.style.display = 'none';
  }
}

function calcularProyecciones(datos) {
  if (!datos.evolucion_temporal || datos.evolucion_temporal.length < 2) {
    document.getElementById('ritmo-gasto').textContent = '-';
    document.getElementById('proyeccion-fecha').textContent = '-';
    document.getElementById('proyeccion-presupuesto').textContent = '-';
    return;
  }
  
  const ultimo = datos.evolucion_temporal[datos.evolucion_temporal.length - 1].gasto_acumulado;
  const dias = datos.evolucion_temporal.length;
  const ritmo = ultimo / dias;
  
  document.getElementById('ritmo-gasto').textContent = '$' + Math.round(ritmo).toLocaleString('es-CO') + '/día';
  document.getElementById('proyeccion-fecha').textContent = '-';
  document.getElementById('proyeccion-presupuesto').textContent = '-';
}
</script>
{% endblock %}