{% extends "base.html" %}
{% load static humanize %}

{% block content %}
<div class="project-detail-bg py-5">
  <div class="container">

    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="display-5 fw-bold m-0">{{ project.name }}</h1>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-success" href="{% url 'projects:listar_consumos_proyecto' project.id %}">
          <i class="fas fa-chart-line me-1"></i>Ver consumos
        </a>
        <a class="btn btn-outline-dark" href="{% url 'projects:project_graficos' project.id %}">
          <i class="fas fa-chart-bar me-1"></i>Ver gráficos
        </a>
        <a class="btn btn-outline-secondary" href="{{ add_purchases_url|default:'#' }}"> Agregar compras</a>
        <a class="btn btn-dark" href="{{ details_url|default:'#' }}">Ver detalles</a>
      </div>
    </div>

    <!-- Presupuestos -->
<div class="row g-3 mb-4">
  <!-- Presupuesto inicial -->
  <div class="col-md-4">
    <div class="p-4 bg-white rounded-4 shadow-sm d-flex justify-content-between align-items-center">
      <div>
        <div class="text-muted">Presupuesto inicial</div>
        <div class="fs-3 fw-semibold">
          ${{ project.presupuesto|floatformat:0|intcomma }}
        </div>
      </div>
      <span class="btn btn-success px-4 disabled">Inicial</span>
    </div>
  </div>

  <!-- Presupuesto gastado -->
  <div class="col-md-4">
    <div class="p-4 bg-white rounded-4 shadow-sm d-flex justify-content-between align-items-center">
      <div>
        <div class="text-muted">Presupuesto gastado</div>
        <div class="fs-3 fw-semibold">
          ${{ project.presupuesto_gastado_calculado|floatformat:0|intcomma }}
        </div>
      </div>
      <span class="btn btn-danger px-4 disabled">Gastado</span>
    </div>
  </div>

  <!-- Presupuesto actual -->
  <div class="col-md-4">
    <div class="p-4 bg-white rounded-4 shadow-sm d-flex justify-content-between align-items-center">
      <div>
        <div class="text-muted">Presupuesto actual</div>
        <div class="fs-3 fw-semibold">
          ${{ project.presupuesto_actual|floatformat:0|intcomma }}
        </div>
      </div>
      <span class="btn btn-warning px-4 disabled">Disponible</span>
    </div>
  </div>
</div>


    <!-- Dos columnas -->
    <div class="row g-4">
      <!-- Columna izquierda: listado de compras -->
      <div class="col-12 col-lg-6">
        <div class="p-5 bg-white rounded-4 shadow-sm text-muted">
          <h5 class="mb-3 fw-semibold">Listado de compras y stock</h5>

          {% if compras %}
            <ul class="list-group list-group-flush">
              {% for item in compras %}
                <li class="list-group-item">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1">
                      <strong>{{ item.material.name }}</strong>
                      <br>
                      <small class="text-muted">
                        <span class="badge bg-secondary">{{ item.entradas|length }} compra(s)</span>
                      </small>
                    </div>
                    <div class="d-flex gap-2">
                      <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse"
                              data-bs-target="#compras-{{ item.material.id }}" aria-expanded="false">
                        <i class="fas fa-shopping-cart"></i> Ver compras
                      </button>
                      <button class="btn btn-sm btn-outline-warning" type="button" data-bs-toggle="collapse"
                              data-bs-target="#gastos-{{ item.material.id }}" aria-expanded="false">
                        <i class="fas fa-chart-line"></i> Ver gastos
                      </button>
                    </div>
                  </div>

                  <!-- Stock info consolidado -->
                  <div class="mt-2 p-2 bg-light rounded">
                    <div class="row text-center">
                      <div class="col-4">
                        <small class="text-muted d-block">Total comprado</small>
                        <span class="badge bg-primary fs-6">{{ item.cantidad_total }}</span>
                      </div>
                      <div class="col-4">
                        <small class="text-muted d-block">Total consumido</small>
                        <span class="badge bg-warning fs-6">{{ item.cantidad_consumida|default:0|floatformat:0 }}</span>
                      </div>
                      <div class="col-4">
                        <small class="text-muted d-block">Stock disponible</small>
                        <span class="badge bg-success fs-6">{{ item.stock_proyecto|floatformat:0 }}</span>
                      </div>
                    </div>
                  </div>

                  <!-- Detalle de compras (colapsable) -->
                  <div class="collapse mt-3" id="compras-{{ item.material.id }}">
                    <div class="card card-body bg-light">
                      <h6 class="fw-bold mb-2"><i class="fas fa-shopping-cart me-2"></i>Detalle de compras:</h6>
                      {% for entrada in item.entradas %}
                        <div class="border-bottom pb-2 mb-2">
                          <div class="d-flex justify-content-between align-items-start">
                            <div class="small">
                              <strong>Lote:</strong> {{ entrada.lote }}<br>
                              <strong>Cantidad:</strong> {{ entrada.cantidad }}<br>
                              {% if entrada.proveedor %}
                                <strong>Proveedor:</strong> {{ entrada.proveedor.name }}<br>
                              {% endif %}
                              <strong>Fecha:</strong> {{ entrada.fecha_ingreso|date:"d M Y" }}
                            </div>
                            <div class="d-flex gap-1">
                              <a href="{% url 'projects:editar_entrada_material' entrada.id %}"
                                 class="btn btn-xs btn-outline-secondary" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">
                                <i class="fas fa-edit"></i>
                              </a>
                              <button type="button" class="btn btn-xs btn-outline-danger"
                                      style="font-size: 0.7rem; padding: 0.2rem 0.5rem;"
                                      data-bs-toggle="modal" data-bs-target="#deleteModal{{ entrada.id }}">
                                <i class="fas fa-trash"></i>
                              </button>
                            </div>
                          </div>

                          <!-- Modal de confirmación para cada lote -->
                          <div class="modal fade" id="deleteModal{{ entrada.id }}" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                              <div class="modal-content">
                                <div class="modal-header bg-danger text-white">
                                  <h5 class="modal-title">Confirmar eliminación</h5>
                                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                  ¿Seguro que quieres eliminar la entrada de
                                  <strong>{{ entrada.material.name }}</strong> (Lote {{ entrada.lote }})?
                                  Esta acción no se puede deshacer.
                                </div>
                                <div class="modal-footer">
                                  <form method="post" action="{% url 'projects:borrar_entrada_material' entrada.id %}">
                                    {% csrf_token %}
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-danger">Sí, eliminar</button>
                                  </form>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- Detalle de gastos/consumos (colapsable) -->
                  <div class="collapse mt-3" id="gastos-{{ item.material.id }}">
                    <div class="card card-body bg-warning bg-opacity-10 border-warning">
                      <h6 class="fw-bold mb-2"><i class="fas fa-chart-line me-2"></i>Detalle de consumos:</h6>
                      {% if item.consumos %}
                        {% for consumo in item.consumos %}
                          <div class="border-bottom border-warning pb-2 mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                              <div class="small">
                                <strong>Fecha:</strong> {{ consumo.fecha_consumo|date:"d M Y" }}<br>
                                <strong>Cantidad:</strong> {{ consumo.cantidad_consumida }} {{ item.material.unit.symbol }}<br>
                                <strong>Actividad:</strong> {{ consumo.componente_actividad }}<br>
                                <strong>Responsable:</strong> {{ consumo.responsable }}<br>
                                {% if consumo.observaciones %}
                                  <strong>Observaciones:</strong> {{ consumo.observaciones }}<br>
                                {% endif %}
                                <small class="text-muted">Registrado por {{ consumo.registrado_por.username }} el {{ consumo.fecha_registro|date:"d/m/Y H:i" }}</small>
                              </div>
                              <div class="d-flex gap-1">
                                <a href="{% url 'projects:editar_consumo_material' consumo.id %}"
                                   class="btn btn-xs btn-outline-secondary" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">
                                  <i class="fas fa-edit"></i>
                                </a>
                                <button type="button" class="btn btn-xs btn-outline-danger"
                                        style="font-size: 0.7rem; padding: 0.2rem 0.5rem;"
                                        data-bs-toggle="modal" data-bs-target="#deleteConsumoModal{{ consumo.id }}">
                                  <i class="fas fa-trash"></i>
                                </button>
                              </div>
                            </div>

                            <!-- Modal de confirmación para cada consumo -->
                            <div class="modal fade" id="deleteConsumoModal{{ consumo.id }}" tabindex="-1" aria-hidden="true">
                              <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                  <div class="modal-header bg-danger text-white">
                                    <h5 class="modal-title">Confirmar eliminación de consumo</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                  </div>
                                  <div class="modal-body">
                                    ¿Seguro que quieres eliminar este consumo de
                                    <strong>{{ consumo.cantidad_consumida }} {{ item.material.unit.symbol }}</strong>?
                                    El stock se restaurará automáticamente.
                                  </div>
                                  <div class="modal-footer">
                                    <form method="post" action="{% url 'projects:eliminar_consumo_material' consumo.id %}">
                                      {% csrf_token %}
                                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                      <button type="submit" class="btn btn-danger">Sí, eliminar</button>
                                    </form>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        {% endfor %}
                      {% else %}
                        <p class="text-muted mb-0 small">
                          <i class="fas fa-info-circle me-2"></i>No hay consumos registrados para este material.
                        </p>
                      {% endif %}
                    </div>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-center text-muted">No hay compras registradas aún.</p>
          {% endif %}
        </div>
      </div>

      <!-- Columna derecha: calendario -->
      <div class="col-12 col-lg-6">
        <div class="p-4 bg-white rounded-4 shadow-sm">
          <h5 class="mb-3 fw-semibold">Control de Gastos Diario</h5>

          <!-- Leyenda del calendario (RF17C) -->
          <div class="mb-3 p-2 bg-light rounded">
            <small class="fw-bold d-block mb-2">Leyenda:</small>
            <div class="d-flex flex-wrap gap-3">
              <div class="d-flex align-items-center">
                <span class="badge bg-success me-2">✓</span>
                <small>Día con registro completo</small>
              </div>
              <div class="d-flex align-items-center">
                <span class="badge bg-secondary me-2">⚠</span>
                <small>Día sin registros</small>
              </div>
              <div class="d-flex align-items-center">
                <span class="badge bg-primary me-2">●</span>
                <small>Día actual</small>
              </div>
            </div>
          </div>

          <div id="calendar" class="calendar">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <button class="btn btn-outline-secondary btn-sm" data-cal-prev>&larr;</button>
              <div class="fw-semibold" data-cal-title>Mes Año</div>
              <button class="btn btn-outline-secondary btn-sm" data-cal-next>&rarr;</button>
            </div>
            <div class="cal-grid"></div>
            <input type="hidden" id="selected_date" name="selected_date">
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Opciones de Día -->
    <div class="modal fade" id="dayOptionsModal" tabindex="-1" aria-labelledby="dayOptionsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-inclusive-primary text-white">
            <h5 class="modal-title" id="dayOptionsModalLabel">
              <i class="fas fa-calendar-day me-2"></i>
              Opciones para <span id="modal-selected-date"></span>
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <!-- Resumen de consumos del día -->
            <div id="day-summary" class="mb-3 p-3 bg-light rounded">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <i class="fas fa-info-circle text-primary me-2"></i>
                  <strong>Estado del día:</strong>
                </div>
                <span id="day-status-badge" class="badge"></span>
              </div>
              <div id="day-consumos-count" class="mt-2 small text-muted"></div>
            </div>

            <!-- Opciones de acción -->
            <div class="d-grid gap-3">
              <a href="#" id="btn-agregar-consumo" class="btn btn-lg btn-success d-flex align-items-center justify-content-center">
                <i class="fas fa-plus-circle me-2 fs-5"></i>
                <div class="text-start">
                  <div class="fw-bold">Agregar consumo</div>
                  <small class="opacity-75">Registrar uso de materiales</small>
                </div>
              </a>

              <a href="#" id="btn-ver-consumos" class="btn btn-lg btn-outline-primary d-flex align-items-center justify-content-center">
                <i class="fas fa-eye me-2 fs-5"></i>
                <div class="text-start">
                  <div class="fw-bold">Ver consumos del día</div>
                  <small class="opacity-75">Detalle de registros</small>
                </div>
              </a>
            </div>

            <!-- Detalle de consumos (colapsable) -->
            <div class="mt-3">
              <button class="btn btn-sm btn-link text-decoration-none p-0" type="button" data-bs-toggle="collapse"
                      data-bs-target="#consumos-detalle-preview" aria-expanded="false">
                <i class="fas fa-chevron-down me-1"></i>
                <small>Ver vista previa de consumos</small>
              </button>
              <div class="collapse mt-2" id="consumos-detalle-preview">
                <div id="consumos-preview-content" class="p-3 border rounded bg-white" style="max-height: 200px; overflow-y: auto;">
                  <div class="text-center text-muted py-3">
                    <i class="fas fa-spinner fa-spin"></i> Cargando...
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<link rel="stylesheet" href="{% static 'css/board.css' %}">
<script>
  // Pasar el ID del proyecto al JavaScript
  window.PROJECT_ID = {{ project.id }};
</script>
<script src="{% static 'js/calendar.js' %}"></script>
{% endblock %}
