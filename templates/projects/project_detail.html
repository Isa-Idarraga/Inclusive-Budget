{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
{% csrf_token %}
<div class="project-detail-bg py-5">
    <div class="container">
        <!-- Header del proyecto -->
        <div class="mb-5 animate-fade-in">
            <div class="d-flex align-items-center justify-content-between flex-wrap">
                <div class="mb-3 mb-md-0">
                    <h1 class="display-4 fw-bold text-inclusive-dark mb-2">{{ project.name }}</h1>
                    <p class="fs-5 text-inclusive-secondary d-flex align-items-center">
                        <i class="fas fa-map-marker-alt text-inclusive-primary me-2"></i>
                        {{ project.location_address }}
                    </p>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="d-inline-flex align-items-center px-3 py-2 rounded-pill small fw-semibold shadow-inclusive
                        {% if project.estado == 'terminado' %}status-badge-complete{% elif project.estado == 'en_proceso' %}status-badge-progress{% else %}status-badge-future{% endif %}">
                        <i class="fas fa-circle me-2" style="font-size: 0.75rem;"></i>
                        {{ project.get_estado_display }}
                    </span>
                    <!-- Formulario simple para cambiar estado - Solo visible para el creador o jefe -->
                    {% if user.role == 'JEFE' or user.is_superuser or project.creado_por.id == user.id %}
                    <form method="post" action="{% url 'projects:update_project_status' project.id %}" class="d-inline">
                        {% csrf_token %}
                        <select name="status" class="form-select form-select-sm d-inline-block me-2" style="width: auto;" onchange="this.form.submit()">
                            <option value="futuro" {% if project.estado == 'futuro' %}selected{% endif %}>üïê Futuro</option>
                            <option value="en_proceso" {% if project.estado == 'en_proceso' %}selected{% endif %}>‚ö° En Proceso</option>
                            <option value="terminado" {% if project.estado == 'terminado' %}selected{% endif %}>‚úÖ Terminado</option>
                        </select>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Columna principal - Informaci√≥n del proyecto -->
            <div class="col-lg-8">
                <!-- Imagen del proyecto -->
                {% if project.imagen_proyecto %}
                <div class="card shadow-inclusive-lg rounded-4 overflow-hidden mb-4 animate-fade-in animate-delay-1">
                    <div class="position-relative overflow-hidden">
                        <img src="{{ project.imagen_proyecto.url }}" alt="{{ project.name }}" class="card-img-top" style="height: 24rem; object-fit: cover; transition: transform 0.3s ease;">
                        <div class="position-absolute top-0 start-0 w-100 h-100 bg-gradient-to-b from-transparent to-black opacity-0 hover:opacity-30 transition-opacity duration-300"></div>
                    </div>
                </div>
                {% endif %}

                <!-- Informaci√≥n General -->
                <div class="card shadow-inclusive-lg rounded-4 mb-4 animate-fade-in animate-delay-2">
                    <div class="card-header card-header-inclusive rounded-top-4 border-0">
                        <div class="d-flex align-items-center">
                            <div class="bg-white bg-opacity-20 rounded-3 d-flex align-items-center justify-content-center me-3" style="width: 3rem; height: 3rem;">
                                <i class="fas fa-info-circle text-white fs-4"></i>
                            </div>
                            <h2 class="h3 fw-bold mb-0">Informaci√≥n General</h2>
                        </div>
                    </div>
                    <div class="card-body p-0 bg-gray-green-accent">
                        <div class="row g-0">
                            <!-- Ubicaci√≥n (direcci√≥n real) -->
                            <div class="col-12 p-4 accent-green-border border-bottom">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-map-marker-alt text-inclusive-primary me-3 fs-5"></i>
                                    <div class="flex-fill">
                                        <p class="small text-inclusive-secondary fw-medium mb-1">Ubicaci√≥n</p>
                                        <p class="text-inclusive-dark fw-semibold mb-0">
                                            {{ project.location_address }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Descripci√≥n -->
                            {% if project.description %}
                            <div class="col-12 p-4 accent-green-border border-bottom">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-align-left text-inclusive-neon me-3 fs-5 mt-1"></i>
                                    <div class="flex-fill">
                                        <p class="small text-inclusive-secondary fw-medium mb-1">Descripci√≥n</p>
                                        <p class="text-inclusive-dark mb-0">{{ project.description }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Fecha de Creaci√≥n -->
                            <div class="col-12 p-4 accent-green-border border-bottom">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-calendar-alt text-inclusive-primary me-3 fs-5"></i>
                                    <div class="flex-fill">
                                        <p class="small text-inclusive-secondary fw-medium mb-1">Fecha de Creaci√≥n</p>
                                        <p class="text-inclusive-dark fw-semibold mb-0">{{ project.fecha_creacion|date:"d/m/Y H:i" }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Creado Por -->
                            <div class="col-12 p-4 accent-green-border {% if not project.workers.exists %}rounded-bottom-4{% endif %}">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-user-tie text-inclusive-neon me-3 fs-5"></i>
                                    <div class="flex-fill">
                                        <p class="small text-inclusive-secondary fw-medium mb-1">Creado Por</p>
                                        <p class="text-inclusive-dark fw-semibold mb-0">
                                            {{ project.creado_por.first_name }} {{ project.creado_por.last_name }}
                                            <span class="badge bg-inclusive-primary ms-2">{{ project.creado_por.get_role_display }}</span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Trabajadores Asignados -->
                            {% if project.workers.exists %}
                            <div class="col-12 p-4 accent-green-border rounded-bottom-4">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-users text-inclusive-primary me-3 fs-5 mt-1"></i>
                                    <div class="flex-fill">
                                        <p class="small text-inclusive-secondary fw-medium mb-2">Trabajadores Asignados</p>
                                        <div class="d-flex flex-wrap gap-2">
                                            {% for worker in project.workers.all %}
                                            <div class="d-flex align-items-center bg-light rounded-pill px-3 py-2">
                                                <i class="fas fa-user text-inclusive-primary me-2"></i>
                                                <div>
                                                    <span class="fw-semibold text-inclusive-dark">{{ worker.name }}</span>
                                                    {% if worker.role %}
                                                        <br><small class="text-muted">{{ worker.role.name }}</small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Section divider -->
                <div class="section-divider"></div>

                <!-- Resumen del Presupuesto Detallado o Dimensiones -->
                <div class="card shadow-inclusive-lg rounded-4 animate-fade-in animate-delay-3">
                    <div class="card-header card-header-inclusive rounded-top-4 border-0">
                        <div class="d-flex align-items-center">
                            <div class="bg-white bg-opacity-20 rounded-3 d-flex align-items-center justify-content-center me-3" style="width: 3rem; height: 3rem;">
                                {% if project.has_detailed_budget_items %}
                                    <i class="fas fa-calculator text-white fs-4"></i>
                                {% else %}
                                    <i class="fas fa-ruler-combined text-white fs-4"></i>
                                {% endif %}
                            </div>
                            <h2 class="h3 fw-bold mb-0">
                                {% if project.has_detailed_budget_items %}
                                    Resumen del Presupuesto Detallado
                                {% else %}
                                    Dimensiones del Proyecto
                                {% endif %}
                            </h2>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        {% if project.has_detailed_budget_items %}
                            <!-- Mini resumen de secciones principales -->
                            <div class="alert alert-info mb-4">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Proyecto con presupuesto detallado</strong> - Este proyecto fue creado con el sistema de 23 secciones detalladas.
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center p-3 bg-light rounded-3">
                                        <i class="fas fa-check-circle text-success fs-4 me-3"></i>
                                        <div>
                                            <h6 class="mb-0 fw-bold">√çtems del Presupuesto</h6>
                                            <p class="mb-0 text-muted">{{ project.budget_items.count }} √≠tems configurados</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center p-3 bg-light rounded-3">
                                        <i class="fas fa-list-ol text-primary fs-4 me-3"></i>
                                        <div>
                                            <h6 class="mb-0 fw-bold">Secciones Activas</h6>
                                            <p class="mb-0 text-muted">23 secciones del presupuesto</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        {% else %}
                        <div class="row g-3">
                            <div class="col-md-6 col-lg-4">
                                <div class="metric-card-primary p-4 rounded-4">
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <i class="fas fa-home text-inclusive-primary fs-3"></i>
                                        <span class="h3 fw-bold text-inclusive-primary mb-0">{{ project.area_construida_total|default:project.built_area|floatformat:0 }}</span>
                                    </div>
                                    <p class="text-inclusive-primary fw-semibold mb-1">√Årea Construida</p>
                                    <p class="text-inclusive-secondary small mb-0">metros cuadrados</p>
                                </div>
                            </div>
                            
                            <div class="col-md-6 col-lg-4">
                                <div class="metric-card-success p-4 rounded-4">
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <i class="fas fa-tree text-inclusive-neon fs-3"></i>
                                        <span class="h3 fw-bold text-inclusive-neon mb-0">{{ project.area_exterior_intervenir|default:project.exterior_area|floatformat:0 }}</span>
                                    </div>
                                    <p class="text-inclusive-neon fw-semibold mb-1">√Årea Exterior a Intervenir</p>
                                    <p class="text-inclusive-secondary small mb-0">metros cuadrados</p>
                                </div>
                            </div>
                            
                            <div class="col-md-6 col-lg-4">
                                <div class="metric-card-secondary p-4 rounded-4">
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <i class="fas fa-columns text-inclusive-secondary fs-3"></i>
                                        <span class="h3 fw-bold text-inclusive-secondary mb-0">{{ project.numero_banos|default:"1" }}</span>
                                    </div>
                                    <p class="text-inclusive-secondary fw-semibold mb-1">Ba√±os Completos</p>
                                    <p class="text-inclusive-secondary small mb-0">{{ project.get_nivel_enchape_banos_display|default:"medio" }}</p>
                                </div>
                            </div>
                            
                            <div class="col-md-6 col-lg-4">
                                <div class="metric-card-warning p-4 rounded-4">
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <i class="fas fa-wall text-inclusive-bright fs-3"></i>
                                        <span class="h3 fw-bold text-inclusive-bright mb-0">
                                            {% if project.walls_area and project.walls_area > 0 %}
                                                {{ project.walls_area|floatformat:1 }}
                                            {% else %}
                                                <span class="text-muted">Calculando...</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                    <p class="text-inclusive-bright fw-semibold mb-1">√Årea de Paredes</p>
                                    <p class="text-inclusive-secondary small mb-0">metros cuadrados</p>
                                </div>
                            </div>
                            
                            <div class="col-md-6 col-lg-4">
                                <div class="metric-card-primary p-4 rounded-4">
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <i class="fas fa-window-maximize text-inclusive-primary fs-3"></i>
                                        <span class="h3 fw-bold text-inclusive-primary mb-0">
                                            {% if project.windows_area and project.windows_area > 0 %}
                                                {{ project.windows_area|floatformat:1 }}
                                            {% else %}
                                                <span class="text-muted">Calculando...</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                    <p class="text-inclusive-primary fw-semibold mb-1">√Årea de Ventanas</p>
                                    <p class="text-inclusive-secondary small mb-0">metros cuadrados</p>
                                </div>
                            </div>
                            
                            <div class="col-md-6 col-lg-4">
                                <div class="metric-card-secondary p-4 rounded-4">
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <i class="fas fa-door-open text-inclusive-secondary fs-3"></i>
                                        <span class="h3 fw-bold text-inclusive-secondary mb-0">
                                            {% if project.doors_count and project.doors_count > 0 %}
                                                {{ project.doors_count }}
                                            {% else %}
                                                <span class="text-muted">Calculando...</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                    <p class="text-inclusive-secondary fw-semibold mb-1">Puertas</p>
                                    <p class="text-inclusive-secondary small mb-0">{{ project.doors_height|default:"2.10" }}m altura</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Sidebar - Presupuesto y Acciones -->
            <div class="col-lg-4">
                <!-- Presupuesto Estimado -->
                <div class="card shadow-inclusive-lg rounded-4 mb-4 animate-fade-in animate-delay-2">
                    <div class="card-header card-header-inclusive rounded-top-4 border-0">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="bg-white bg-opacity-20 rounded-3 d-flex align-items-center justify-content-center me-3" style="width: 3rem; height: 3rem;">
                                    <i class="fas fa-dollar-sign text-white fs-4"></i>
                                </div>
                                <h3 class="h4 fw-bold mb-0">Presupuesto Estimado</h3>
                            </div>
                            <button type="button" class="btn btn-outline-light btn-sm" onclick="recalculateFields()" title="Recalcular campos">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-4 bg-gray-green-accent">
                        <div class="text-center mb-4 p-4 rounded-4 border border-3" style="border-color: var(--inclusive-green-primary); background-color: var(--inclusive-gray-medium);">
                            <div class="display-5 fw-bold text-inclusive-primary mb-2">
                                ${{ estimated_budget|floatformat:0|intcomma }}
                            </div>
                            <p class="text-inclusive-secondary small mb-0">Pesos Colombianos</p>
                        </div>
                        
                        
                        <div class="accent-green-border rounded-4 p-4">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-info-circle text-inclusive-primary mt-1 me-3 fs-5"></i>
                                <div class="small text-inclusive-secondary">
                                    <p class="fw-semibold mb-2 text-inclusive-dark">
                                        <i class="fas fa-exclamation-triangle text-inclusive-bright me-1"></i>
                                        Nota importante:
                                    </p>
                                    <p class="mb-0">Este es un presupuesto estimado basado en las dimensiones proporcionadas. Los precios reales pueden variar seg√∫n materiales, ubicaci√≥n y otros factores.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Acciones - Solo visible para el creador o jefe -->
                {% if user.role == 'JEFE' or user.is_superuser or project.creado_por.id == user.id %}
                <div class="card shadow-inclusive-lg rounded-4 animate-fade-in animate-delay-4">
                    <div class="card-header card-header-inclusive rounded-top-4 border-0">
                        <div class="d-flex align-items-center">
                            <div class="bg-white bg-opacity-20 rounded-3 d-flex align-items-center justify-content-center me-3" style="width: 3rem; height: 3rem;">
                                <i class="fas fa-cogs text-white fs-4"></i>
                            </div>
                            <h3 class="h4 fw-bold mb-0">Acciones</h3>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="d-grid gap-3">
                            <!-- Botones para Presupuesto Detallado -->
                            {% if user.role == 'JEFE' or user.role == 'CONSTRUCTOR' or user.is_superuser %}
                            <a href="{% url 'projects:detailed_budget_edit' project.id %}" class="btn btn-inclusive-warning d-flex align-items-center justify-content-center rounded-3" id="edit-budget-btn">
                                <i class="fas fa-calculator me-2"></i>
                                <span class="btn-text">Editar Presupuesto Detallado</span>
                                <span class="btn-loading" style="display: none;">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    Cargando...
                                </span>
                            </a>
                            
                            {% endif %}
                            
                            <!-- Cambiar Foto del Proyecto -->
                            <button type="button" class="btn btn-inclusive-primary d-flex align-items-center justify-content-center rounded-3" onclick="changeProjectImage()">
                                <i class="fas fa-camera me-2"></i>
                                Cambiar Foto del Proyecto
                            </button>
                            
                            <!-- Gesti√≥n de Trabajadores -->
                            <a href="{% url 'projects:project_workers' project.id %}" class="btn btn-inclusive-primary d-flex align-items-center justify-content-center rounded-3">
                                <i class="fas fa-users me-2"></i>
                                Gestionar Trabajadores
                            </a>
                            
                            <a href="{% url 'projects:project_delete' project.id %}" class="btn btn-inclusive-secondary d-flex align-items-center justify-content-center rounded-3">
                                <i class="fas fa-trash me-2"></i>
                                Eliminar Proyecto
                            </a>
                            
                            <a href="{% url 'projects:project_list' %}" class="btn btn-inclusive-secondary d-flex align-items-center justify-content-center rounded-3">
                                <i class="fas fa-list me-2"></i>
                                Ver Todos los Proyectos
                            </a>
                            
                            <a href="{% url 'projects:project_create' %}" class="btn btn-inclusive-warning d-flex align-items-center justify-content-center rounded-3">
                                <i class="fas fa-plus me-2"></i>
                                Crear Nuevo Proyecto
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function recalculateFields() {
    const button = event.target.closest('button');
    const icon = button.querySelector('i');
    
    // Cambiar icono a loading
    icon.className = 'fas fa-spinner fa-spin';
    button.disabled = true;
    
    // Hacer petici√≥n AJAX para recalcular
    fetch(`{% url 'projects:recalculate_legacy_fields' project.id %}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Recargar la p√°gina para mostrar los nuevos valores
            location.reload();
        } else {
            alert('Error al recalcular: ' + data.error);
            // Restaurar bot√≥n
            icon.className = 'fas fa-sync-alt';
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al recalcular los campos');
        // Restaurar bot√≥n
        icon.className = 'fas fa-sync-alt';
        button.disabled = false;
    });
}

// Manejar el bot√≥n de editar presupuesto detallado
document.addEventListener('DOMContentLoaded', function() {
    const editBudgetBtn = document.getElementById('edit-budget-btn');
    if (editBudgetBtn) {
        editBudgetBtn.addEventListener('click', function(e) {
            const btnText = this.querySelector('.btn-text');
            const btnLoading = this.querySelector('.btn-loading');
            
            if (btnText && btnLoading) {
                btnText.style.display = 'none';
                btnLoading.style.display = 'inline';
                this.style.pointerEvents = 'none';
                
                // Timeout de seguridad
                setTimeout(() => {
                    btnText.style.display = 'inline';
                    btnLoading.style.display = 'none';
                    this.style.pointerEvents = 'auto';
                }, 10000); // 10 segundos timeout
            }
        });
    }
});

// Funci√≥n para cambiar la imagen del proyecto
function changeProjectImage() {
    // Crear input file oculto
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.style.display = 'none';
    
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            // Validar tama√±o del archivo (m√°ximo 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('El archivo es demasiado grande. Por favor selecciona una imagen menor a 5MB.');
                return;
            }
            
            // Validar tipo de archivo
            if (!file.type.startsWith('image/')) {
                alert('Por favor selecciona un archivo de imagen v√°lido.');
                return;
            }
            
            // Crear FormData para enviar el archivo
            const formData = new FormData();
            formData.append('imagen_proyecto', file);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // Mostrar indicador de carga
            const button = document.querySelector('button[onclick="changeProjectImage()"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Subiendo...';
            button.disabled = true;
            
            // Enviar archivo al servidor
            fetch(`{% url 'projects:update_project_image' project.id %}`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Actualizar la imagen en la p√°gina
                    const imgElement = document.querySelector('.card-img-top');
                    if (imgElement) {
                        imgElement.src = data.image_url + '?t=' + new Date().getTime();
                    } else {
                        // Si no existe el elemento de imagen, recargar la p√°gina
                        location.reload();
                    }
                    alert('Imagen actualizada correctamente');
                } else {
                    alert('Error al actualizar la imagen: ' + (data.error || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al subir la imagen');
            })
            .finally(() => {
                // Restaurar bot√≥n
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }
    };
    
    // Agregar input al DOM y hacer clic
    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
}
</script>
{% endblock %}