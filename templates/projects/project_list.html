{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
    /* Estilos para filtros simplificados */
    .search-container {
        background: linear-gradient(135deg, var(--inclusive-light) 0%, var(--inclusive-gray-light) 100%);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .search-input {
        border: 2px solid var(--inclusive-gray-light);
        border-radius: 15px;
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }
    
    .search-input:focus {
        border-color: var(--inclusive-green-primary);
        box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
        outline: none;
    }
    
    .filter-select {
        border: 2px solid var(--inclusive-gray-light);
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        width: 100%;
        margin-bottom: 1.5rem;
        min-height: 48px;
    }
    
    .filter-select:focus {
        border-color: var(--inclusive-green-primary);
        box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
        outline: none;
    }
    
    /* Asegurar que los campos no se sobrepongan */
    .form-label {
        display: block;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
        font-weight: 600;
        line-height: 1.2;
    }
    
    /* Espaciado adicional para evitar sobreposición */
    .col-md-3, .col-md-6 {
        margin-bottom: 1rem;
    }
    
    /* Asegurar que los campos tengan suficiente espacio vertical */
    .row.g-3 {
        margin-bottom: 1.5rem;
    }
    
    /* Responsive para formulario */
    @media (max-width: 768px) {
        .col-md-3 {
            margin-bottom: 1rem;
        }
        
        .filter-select {
            margin-bottom: 0.5rem;
        }
    }
    
    /* Espaciado adicional entre filas */
    .row.g-3 {
        margin-bottom: 1rem;
    }
    
    /* Estilos para campos de presupuesto */
    .budget-input {
        font-family: 'Courier New', monospace;
        font-weight: 500;
    }
    
    .budget-input:focus {
        border-color: var(--inclusive-green-primary);
        box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
    }
    
    .project-card-hover {
        transition: all 0.3s ease;
    }
    
    .project-card-hover:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }
    
    .status-badge-progress {
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .project-card-hover:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }
    
    .status-badge-progress {
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
    }
    
    /* Botón toggle con transición simple */
    #toggleFiltersBtn {
        transition: all 0.3s ease;
    }
    
    #toggleFiltersBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    /* Badge de IA con animación */
    .ai-badge {
        animation: ai-glow 2s ease-in-out infinite;
    }
    
    @keyframes ai-glow {
        0%, 100% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        50% { box-shadow: 0 6px 25px rgba(102, 126, 234, 0.7); }
    }
</style>
{% endblock %}

{% block content %}
<div class="project-detail-bg py-5">
    <div class="container">
        <!-- Header con búsqueda simplificada -->
        <div class="search-container">
            <div class="text-center mb-4">
                <h2 class="text-inclusive-dark mb-3 fw-bold">
                    <i class="fas fa-building me-2"></i>
                    Lista de Proyectos
                </h2>
                <p class="text-inclusive-secondary">Gestiona y visualiza todos tus proyectos de construcción</p>
                
            <!-- Botón para acceder al historial cronológico -->
            <div class="mt-3">
                <a href="{% url 'projects:project_history' %}" class="btn btn-outline-success btn-lg border-2">
                    <i class="fas fa-history me-2"></i>
                    Ver Historial Cronológico
                </a>
            </div>
            </div>
            
            <!-- Búsqueda y filtros básicos -->
            <form method="get" action="{% url 'projects:project_list' %}" id="filtersForm">
                <!-- Fila 1: Búsqueda principal -->
                <div class="row g-3 mb-3">
                    <div class="col-md-8">
                            <div class="input-group input-group-lg">
                            <span class="input-group-text bg-inclusive-primary text-white">
                                <i class="fas fa-search"></i>
                            </span>
                                <input type="text" 
                                       name="search" 
                                   class="form-control search-input" 
                                   placeholder="Buscar por nombre, descripción o ubicación..."
                                   value="{{ search_query|default:'' }}"
                                       aria-label="Buscar proyectos">
                    </div>
                </div>
                
                    <div class="col-md-2">
                        <select name="status" class="form-select filter-select">
                                        <option value="">Todos los estados</option>
                            <option value="futuro" {% if status_filter == 'futuro' %}selected{% endif %}>Futuro</option>
                            <option value="en_proceso" {% if status_filter == 'en_proceso' %}selected{% endif %}>En Proceso</option>
                            <option value="terminado" {% if status_filter == 'terminado' %}selected{% endif %}>Terminado</option>
                                    </select>
                                </div>
                                
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-inclusive-primary btn-lg w-100">
                            <i class="fas fa-search me-2"></i>Buscar
                    </button>
                </div>
                                </div>
                                
                <!-- Botón para mostrar/ocultar filtros adicionales -->
                <div class="text-center mb-3">
                    <button type="button" class="btn btn-outline-inclusive-primary" id="toggleAdvancedFilters">
                        <i class="fas fa-filter me-2"></i>
                        <span id="toggleAdvancedText">Mostrar Filtros Avanzados</span>
                        <i class="fas fa-chevron-down ms-2" id="toggleAdvancedIcon"></i>
                    </button>
                                </div>
                                
                <!-- Filtros adicionales (inicialmente ocultos) -->
                <div id="advancedFilters" style="display: none;">
                    <!-- Fila 2: Filtros adicionales -->
                    <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold text-inclusive-primary">
                            <i class="fas fa-users me-2"></i>Trabajadores
                                    </label>
                        <select name="trabajadores" class="form-select filter-select">
                            <option value="">Cualquier cantidad</option>
                            <option value="0" {% if trabajadores_filter == '0' %}selected{% endif %}>Sin trabajadores</option>
                            <option value="1-3" {% if trabajadores_filter == '1-3' %}selected{% endif %}>1-3 trabajadores</option>
                            <option value="4-6" {% if trabajadores_filter == '4-6' %}selected{% endif %}>4-6 trabajadores</option>
                            <option value="7+" {% if trabajadores_filter == '7+' %}selected{% endif %}>7+ trabajadores</option>
                                    </select>
                                </div>
                                
                    <div class="col-md-3">
                        <label class="form-label fw-semibold text-inclusive-primary">
                            <i class="fas fa-user-tie me-2"></i>Creado por
                                    </label>
                        <select name="creador" class="form-select filter-select">
                            <option value="">Todos los usuarios</option>
                                        {% for creador in creadores %}
                                        <option value="{{ creador.id }}" {% if creador_filter == creador.id|stringformat:"s" %}selected{% endif %}>
                                {{ creador.first_name }} {{ creador.last_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold text-inclusive-primary">
                            <i class="fas fa-calendar me-2"></i>Fecha desde
                                    </label>
                        <input type="date" 
                               name="fecha_desde" 
                               class="form-control filter-select"
                               value="{{ fecha_desde_filter|default:'' }}">
                                </div>
                                
                    <div class="col-md-3">
                        <label class="form-label fw-semibold text-inclusive-primary">
                            <i class="fas fa-calendar me-2"></i>Fecha hasta
                                    </label>
                        <input type="date" 
                               name="fecha_hasta" 
                               class="form-control filter-select"
                               value="{{ fecha_hasta_filter|default:'' }}">
                    </div>
                                </div>
                                
                <!-- Fila 3: Filtro de ubicación -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold text-inclusive-primary">
                            <i class="fas fa-map-marker-alt me-2"></i>Ubicación del proyecto
                        </label>
                        <input type="text" 
                               name="ubicacion" 
                               class="form-control filter-select"
                               placeholder="Ej: Medellín, Bogotá, Cali..."
                               value="{{ ubicacion_filter|default:'' }}"
                               title="Buscar por ciudad, barrio o dirección">
                    </div>
                    
                    <div class="col-md-6">
                        <!-- Espacio vacío para mantener el layout -->
                    </div>
                </div>
                                
                <!-- Fila 4: Filtros de presupuesto -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold text-inclusive-primary">
                                        <i class="fas fa-dollar-sign me-2"></i>Presupuesto mínimo
                                    </label>
                        <input type="text" 
                                           name="presupuesto_min" 
                               class="form-control filter-select budget-input"
                                           placeholder="0"
                                           value="{{ presupuesto_min_filter|default:'' }}"
                               data-type="budget">
                                </div>
                                
                    <div class="col-md-6">
                        <label class="form-label fw-semibold text-inclusive-primary">
                                        <i class="fas fa-dollar-sign me-2"></i>Presupuesto máximo
                                    </label>
                        <input type="text" 
                                           name="presupuesto_max" 
                               class="form-control filter-select budget-input"
                               placeholder="1.000.000.000"
                                           value="{{ presupuesto_max_filter|default:'' }}"
                               data-type="budget">
                                </div>
                        </div>
                    </div>
                </form>
                
            <!-- Filtros activos -->
            {% if search_query or status_filter or trabajadores_filter or creador_filter or fecha_desde_filter or fecha_hasta_filter or ubicacion_filter or presupuesto_min_filter or presupuesto_max_filter %}
                <div class="mt-4 text-center">
                <div class="d-inline-flex align-items-center bg-inclusive-light px-4 py-2 rounded-pill">
                        <i class="fas fa-filter text-inclusive-primary me-2"></i>
                    <span class="text-inclusive-secondary fw-semibold me-2">Filtros activos:</span>
                        <div class="d-flex flex-wrap gap-1 justify-content-center">
                        {% if search_query %}
                            <span class="badge bg-inclusive-primary me-1">{{ search_query }}</span>
                        {% endif %}
                        {% if status_filter %}
                            <span class="badge bg-inclusive-primary me-1">{{ status_filter|title }}</span>
                        {% endif %}
                        {% if trabajadores_filter %}
                            <span class="badge bg-inclusive-primary me-1">{{ trabajadores_filter }} trabajadores</span>
                        {% endif %}
                        {% if creador_filter %}
                            <span class="badge bg-inclusive-primary me-1">Creado por: {{ creador_nombre|default:creador_filter }}</span>
                        {% endif %}
                        {% if fecha_desde_filter %}
                            <span class="badge bg-inclusive-primary me-1">Desde: {{ fecha_desde_filter }}</span>
                        {% endif %}
                        {% if fecha_hasta_filter %}
                            <span class="badge bg-inclusive-primary me-1">Hasta: {{ fecha_hasta_filter }}</span>
                        {% endif %}
                        {% if ubicacion_filter %}
                            <span class="badge bg-inclusive-primary me-1">📍 {{ ubicacion_filter }}</span>
                        {% endif %}
                        {% if presupuesto_min_filter or presupuesto_max_filter %}
                            <span class="badge bg-inclusive-primary me-1">Presupuesto: ${{ presupuesto_min_filter|default:"0" }}-${{ presupuesto_max_filter|default:"∞" }}</span>
                        {% endif %}
                        </div>
                    <a href="{% url 'projects:project_list' %}" class="btn btn-sm btn-outline-inclusive-secondary ms-2">
                        <i class="fas fa-times"></i> Limpiar
                    </a>
                    </div>
                </div>
                {% endif %}
        </div>
        
        <!-- Espaciador adicional entre filtros y proyectos -->
        <div class="mt-5 mb-4"></div>
        
        <!-- Sin resultados -->
        {% if search_query or status_filter %}
            {% if projects_en_proceso.count == 0 and projects_terminados.count == 0 and projects_futuros.count == 0 %}
            <div class="text-center py-5">
                <div class="card shadow-lg rounded-4 border-0">
                <div class="card-body p-5">
                    <div class="mb-4">
                        <i class="fas fa-search text-inclusive-secondary display-1"></i>
                    </div>
                    <h3 class="text-inclusive-dark mb-3">No se encontraron proyectos</h3>
                    <p class="text-inclusive-secondary mb-4">
                        No hay proyectos que coincidan con los filtros aplicados. 
                        Intenta ajustar los criterios de búsqueda.
                    </p>
                    <a href="{% url 'projects:project_list' %}" class="btn btn-inclusive-primary btn-lg px-4">
                        <i class="fas fa-times me-2"></i>Limpiar Filtros
                    </a>
                </div>
            </div>
        </div>
            {% endif %}
        {% endif %}

        <!-- Proyectos en Proceso -->
        {% if projects_en_proceso %}
        <div class="mb-6 position-relative animate-fade-in animate-delay-1">
            <div class="position-absolute top-0 start-0" style="z-index: 10;">
                <div class="bg-inclusive-primary text-white px-4 py-3 rounded-end-4 shadow-inclusive border-3" style="border-color: var(--inclusive-green-neon);">
                    <h2 class="h5 fw-bold mb-0">
                        <i class="fas fa-play-circle me-2"></i>
                        Proyectos en Proceso ({{ projects_en_proceso.count }})
                    </h2>
                </div>
            </div>
            <div class="row g-4 pt-5">
                {% for project in projects_en_proceso %}
                <div class="col-sm-6 col-lg-4 col-xl-3">
                    <div class="card h-100 shadow-inclusive rounded-4 project-card-hover border-0 animate-fade-in" style="animation-delay: {{ forloop.counter0|add:1 }}00ms;">
                        {% if user.role == 'JEFE' or user.is_superuser or project.creado_por.id == user.id %}
                        <a href="{% url 'projects:project_board' project.id %}" class="text-decoration-none">
                        {% else %}
                        <a href="{% url 'projects:project_detail' project.id %}" class="text-decoration-none">
                        {% endif %}
                            <div class="position-relative overflow-hidden rounded-top-4">
                                {% if project.imagen_proyecto %}
                                    <img class="card-img-top" src="{{ project.imagen_proyecto.url }}" alt="{{ project.name }}" style="height: 14rem; object-fit: cover;" />
                                {% else %}
                                    <div class="card-img-top bg-inclusive-light d-flex align-items-center justify-content-center" style="height: 14rem;">
                                        <i class="fas fa-building display-4 text-inclusive-secondary"></i>
                                    </div>
                                {% endif %}
                                <div class="position-absolute top-0 end-0 m-3">
                                    <div class="d-flex flex-column gap-2 align-items-end">
                                    <span class="badge status-badge-progress rounded-pill px-3 py-2 small fw-semibold">
                                        <i class="fas fa-clock me-1"></i>
                                        En Proceso
                                    </span>
                                        {% if project.created_by_ai %}
                                        <span class="badge rounded-pill px-3 py-2 small fw-semibold ai-badge" 
                                              style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                            <i class="fas fa-robot me-1"></i>
                                            IA
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </a>
                        <div class="card-body card-body-inclusive p-4">
                            <h5 class="card-title h6 fw-bold text-inclusive-dark mb-3">{{ project.name }}</h5>
                            
                            <!-- Información detallada -->
                            <div class="mb-3">
                                <!-- Ubicación del proyecto -->
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-map-marker-alt text-inclusive-primary me-2 small"></i>
                                    <small class="text-inclusive-secondary">
                                        {% if project.location_address %}
                                            {{ project.location_address|truncatechars:30 }}
                                        {% else %}
                                            {{ project.get_ubicacion_proyecto_display|default:"Medellín" }}
                                        {% endif %}
                                    </small>
                                </div>
                                
                                <!-- Creado por -->
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-user-tie text-inclusive-primary me-2 small"></i>
                                    <small class="text-inclusive-secondary">
                                        <strong>Creado por:</strong> {{ project.creado_por.first_name }} {{ project.creado_por.last_name }}
                                    </small>
                                </div>
                                
                                <!-- Indicador de IA -->
                                {% if project.created_by_ai %}
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-robot me-2 small" style="color: #667eea;"></i>
                                    <small class="fw-semibold" style="color: #667eea;">
                                        <i class="fas fa-sparkles me-1"></i>Generado con IA
                                    </small>
                                </div>
                                {% endif %}
                                
                                <!-- Fecha de creación -->
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-calendar text-inclusive-secondary me-2 small"></i>
                                    <small class="text-inclusive-secondary">{{ project.fecha_creacion|date:"d M Y" }}</small>
                                </div>
                                
                                <!-- Indicador de presupuesto detallado -->
                                {% if project.has_detailed_budget_items %}
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-calculator text-inclusive-neon me-2 small"></i>
                                    <small class="text-inclusive-neon fw-semibold">
                                        <i class="fas fa-check-circle me-1"></i>Presupuesto Detallado
                                    </small>
                                </div>
                                {% endif %}

                                <!-- Información técnica (solo si está disponible) -->
                                {% if project.area_construida_total or project.built_area %}
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-home text-inclusive-neon me-2 small"></i>
                                    <small class="text-inclusive-secondary">
                                        {{ project.area_construida_total|default:project.built_area|floatformat:0|default:"0" }}m²
                                        {% if project.get_numero_pisos_display %}• {{ project.get_numero_pisos_display }}{% endif %}
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Presupuesto destacado -->
                            <div class="text-center p-3 rounded-3 border-2" style="border-color: var(--inclusive-green-primary); background-color: var(--inclusive-gray-light);">
                                <small class="text-inclusive-secondary d-block mb-1">Presupuesto Estimado</small>
                                <span class="h6 fw-bold text-inclusive-primary mb-0" data-budget="{{ project.presupuesto|default:0 }}">
                                    {% if project.presupuesto and project.presupuesto > 0 %}
                                        ${{ project.presupuesto|floatformat:0|default:"0" }}
                                    {% else %}
                                        <span class="text-inclusive-bright">Por calcular</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                   </div>
                </div>
               {% endfor %}
           </div>
       </div>
       {% endif %}

       <!-- Proyectos Terminados -->
        {% if projects_terminados %}
        <div class="mb-6 position-relative animate-fade-in animate-delay-2">
            <div class="position-absolute top-0 start-0" style="z-index: 10;">
                <div class="bg-inclusive-neon text-inclusive-dark px-4 py-3 rounded-end-4 shadow-inclusive border-3" style="border-color: var(--inclusive-green-primary);">
                    <h2 class="h5 fw-bold mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        Proyectos Terminados ({{ projects_terminados.count }})
                    </h2>
                </div>
            </div>
            <div class="row g-4 pt-5">
                {% for project in projects_terminados %}
                <div class="col-sm-6 col-lg-4 col-xl-3">
                    <div class="card h-100 shadow-inclusive rounded-4 project-card-hover border-0 animate-fade-in" style="animation-delay: {{ forloop.counter0|add:1 }}00ms;">
                        {% if user.role == 'JEFE' or user.is_superuser or project.creado_por.id == user.id %}
                        <a href="{% url 'projects:project_board' project.id %}" class="text-decoration-none">
                        {% else %}
                        <a href="{% url 'projects:project_detail' project.id %}" class="text-decoration-none">
                        {% endif %}
                            <div class="position-relative overflow-hidden rounded-top-4">
                                {% if project.imagen_proyecto %}
                                    <img class="card-img-top" src="{{ project.imagen_proyecto.url }}" alt="{{ project.name }}" style="height: 14rem; object-fit: cover;" />
                                {% else %}
                                    <div class="card-img-top bg-inclusive-light d-flex align-items-center justify-content-center" style="height: 14rem;">
                                        <i class="fas fa-building display-4 text-inclusive-secondary"></i>
                                    </div>
                                {% endif %}
                                <div class="position-absolute top-0 end-0 m-3">
                                    <div class="d-flex flex-column gap-2 align-items-end">
                                    <span class="badge status-badge-complete rounded-pill px-3 py-2 small fw-semibold">
                                        <i class="fas fa-check me-1"></i>
                                        Terminado
                                    </span>
                                        {% if project.created_by_ai %}
                                        <span class="badge rounded-pill px-3 py-2 small fw-semibold ai-badge" 
                                              style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                            <i class="fas fa-robot me-1"></i>
                                            IA
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </a>
                        <div class="card-body card-body-inclusive p-4">
                            <h5 class="card-title h6 fw-bold text-inclusive-dark mb-3">{{ project.name }}</h5>
                            
                            <!-- Información detallada -->
                            <div class="mb-3">
                                <!-- Ubicación del proyecto -->
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-map-marker-alt text-inclusive-primary me-2 small"></i>
                                    <small class="text-inclusive-secondary">
                                        {% if project.location_address %}
                                            {{ project.location_address|truncatechars:30 }}
                                        {% else %}
                                            {{ project.get_ubicacion_proyecto_display|default:"Medellín" }}
                                        {% endif %}
                                    </small>
                                </div>
                                
                                <!-- Creado por -->
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-user-tie text-inclusive-primary me-2 small"></i>
                                    <small class="text-inclusive-secondary">
                                        <strong>Creado por:</strong> {{ project.creado_por.first_name }} {{ project.creado_por.last_name }}
                                    </small>
                                </div>
                                
                                <!-- Indicador de IA -->
                                {% if project.created_by_ai %}
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-robot me-2 small" style="color: #667eea;"></i>
                                    <small class="fw-semibold" style="color: #667eea;">
                                        <i class="fas fa-sparkles me-1"></i>Generado con IA
                                    </small>
                                </div>
                                {% endif %}
                                
                                <!-- Fecha de creación -->
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-calendar text-inclusive-secondary me-2 small"></i>
                                    <small class="text-inclusive-secondary">{{ project.fecha_creacion|date:"d M Y" }}</small>
                                </div>
                                
                                <!-- Indicador de presupuesto detallado -->
                                {% if project.has_detailed_budget_items %}
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-calculator text-inclusive-neon me-2 small"></i>
                                    <small class="text-inclusive-neon fw-semibold">
                                        <i class="fas fa-check-circle me-1"></i>Presupuesto Detallado
                                    </small>
                                </div>
                                {% endif %}

                                <!-- Información técnica (solo si está disponible) -->
                                {% if project.area_construida_total or project.built_area %}
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-home text-inclusive-neon me-2 small"></i>
                                    <small class="text-inclusive-secondary">
                                        {{ project.area_construida_total|default:project.built_area|floatformat:0|default:"0" }}m²
                                        {% if project.get_numero_pisos_display %}• {{ project.get_numero_pisos_display }}{% endif %}
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Presupuesto destacado -->
                            <div class="text-center p-3 rounded-3 border-2" style="border-color: var(--inclusive-green-neon); background-color: var(--inclusive-gray-light);">
                                <small class="text-inclusive-secondary d-block mb-1">Presupuesto Final</small>
                                <span class="h6 fw-bold text-inclusive-neon mb-0" data-budget="{{ project.presupuesto|default:0 }}">
                                    {% if project.presupuesto and project.presupuesto > 0 %}
                                        ${{ project.presupuesto|floatformat:0|default:"0" }}
                                    {% else %}
                                        <span class="text-inclusive-bright">Calculando...</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                   </div>
                </div>
               {% endfor %}
           </div>
       </div>
       {% endif %}

       <!-- Proyectos Futuros -->
        {% if projects_futuros %}
        <div class="mb-6 position-relative animate-fade-in animate-delay-3">
            <div class="position-absolute top-0 start-0" style="z-index: 10;">
                <div class="bg-inclusive-secondary text-white px-4 py-3 rounded-end-4 shadow-inclusive border-3" style="border-color: var(--inclusive-gray-dark);">
                    <h2 class="h5 fw-bold mb-0">
                        <i class="fas fa-clock me-2"></i>
                        Proyectos Futuros ({{ projects_futuros.count }})
                    </h2>
                </div>
            </div>
            <div class="row g-4 pt-5">
                {% for project in projects_futuros %}
                <div class="col-sm-6 col-lg-4 col-xl-3">
                    <div class="card h-100 shadow-inclusive rounded-4 project-card-hover border-0 animate-fade-in" style="animation-delay: {{ forloop.counter0|add:1 }}00ms;">
                        {% if user.role == 'JEFE' or user.is_superuser or project.creado_por.id == user.id %}
                        <a href="{% url 'projects:project_board' project.id %}" class="text-decoration-none">
                        {% else %}
                        <a href="{% url 'projects:project_detail' project.id %}" class="text-decoration-none">
                        {% endif %}
                            <div class="position-relative overflow-hidden rounded-top-4">
                                {% if project.imagen_proyecto %}
                                    <img class="card-img-top" src="{{ project.imagen_proyecto.url }}" alt="{{ project.name }}" style="height: 14rem; object-fit: cover;" />
                                {% else %}
                                    <div class="card-img-top bg-inclusive-light d-flex align-items-center justify-content-center" style="height: 14rem;">
                                        <i class="fas fa-building display-4 text-inclusive-secondary"></i>
                                    </div>
                                {% endif %}
                                <div class="position-absolute top-0 end-0 m-3">
                                    <div class="d-flex flex-column gap-2 align-items-end">
                                    <span class="badge status-badge-future rounded-pill px-3 py-2 small fw-semibold">
                                        <i class="fas fa-calendar me-1"></i>
                                        Futuro
                                    </span>
                                        {% if project.created_by_ai %}
                                        <span class="badge rounded-pill px-3 py-2 small fw-semibold ai-badge" 
                                              style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                            <i class="fas fa-robot me-1"></i>
                                            IA
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </a>
                        <div class="card-body card-body-inclusive p-4">
                            <h5 class="card-title h6 fw-bold text-inclusive-dark mb-3">{{ project.name }}</h5>
                            
                            <!-- Información detallada -->
                            <div class="mb-3">
                                <!-- Ubicación del proyecto -->
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-map-marker-alt text-inclusive-primary me-2 small"></i>
                                    <small class="text-inclusive-secondary">
                                        {% if project.location_address %}
                                            {{ project.location_address|truncatechars:30 }}
                                        {% else %}
                                            {{ project.get_ubicacion_proyecto_display|default:"Medellín" }}
                                        {% endif %}
                                    </small>
                                </div>
                                
                                <!-- Creado por -->
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-user-tie text-inclusive-primary me-2 small"></i>
                                    <small class="text-inclusive-secondary">
                                        <strong>Creado por:</strong> {{ project.creado_por.first_name }} {{ project.creado_por.last_name }}
                                    </small>
                                </div>
                                
                                <!-- Indicador de IA -->
                                {% if project.created_by_ai %}
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-robot me-2 small" style="color: #667eea;"></i>
                                    <small class="fw-semibold" style="color: #667eea;">
                                        <i class="fas fa-sparkles me-1"></i>Generado con IA
                                    </small>
                                </div>
                                {% endif %}
                                
                                <!-- Fecha de creación -->
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-calendar text-inclusive-secondary me-2 small"></i>
                                    <small class="text-inclusive-secondary">{{ project.fecha_creacion|date:"d M Y" }}</small>
                                </div>
                                
                                <!-- Indicador de presupuesto detallado -->
                                {% if project.has_detailed_budget_items %}
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-calculator text-inclusive-neon me-2 small"></i>
                                    <small class="text-inclusive-neon fw-semibold">
                                        <i class="fas fa-check-circle me-1"></i>Presupuesto Detallado
                                    </small>
                                </div>
                                {% endif %}

                                <!-- Información técnica (solo si está disponible) -->
                                {% if project.area_construida_total or project.built_area %}
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-home text-inclusive-secondary me-2 small"></i>
                                    <small class="text-inclusive-secondary">
                                        {{ project.area_construida_total|default:project.built_area|floatformat:0|default:"0" }}m²
                                        {% if project.get_numero_pisos_display %}• {{ project.get_numero_pisos_display }}{% endif %}
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Presupuesto estimado -->
                            <div class="text-center p-3 rounded-3 border-2" style="border-color: var(--inclusive-gray-dark); background-color: var(--inclusive-gray-light);">
                                <small class="text-inclusive-secondary d-block mb-1">Presupuesto Estimado</small>
                                <span class="h6 fw-bold text-inclusive-secondary mb-0" data-budget="{{ project.presupuesto|default:0 }}">
                                    {% if project.presupuesto and project.presupuesto > 0 %}
                                        ${{ project.presupuesto|floatformat:0|default:"0" }}
                                    {% else %}
                                        <span class="text-inclusive-bright">Por calcular</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                   </div>
                </div>
               {% endfor %}
           </div>
       </div>
       {% endif %}

    <!-- Sin proyectos -->
    {% if not projects_en_proceso and not projects_terminados and not projects_futuros %}
    <div class="text-center py-5 animate-fade-in">
        <div class="mx-auto" style="max-width: 28rem;">
            <div class="bg-inclusive-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-4" style="width: 8rem; height: 8rem;">
                <i class="fas fa-folder-open display-2 text-inclusive-secondary"></i>
            </div>
            <h3 class="h4 fw-bold text-inclusive-dark mb-3">No hay proyectos</h3>
            <p class="text-inclusive-secondary mb-4">Comienza creando tu primer proyecto de construcción con nuestro cuestionario detallado</p>
            <a href="{% url 'projects:project_create' %}" class="btn btn-inclusive-primary fw-semibold rounded-4 px-5 py-3">
                <i class="fas fa-plus me-2"></i>
                Crear Primer Proyecto
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Botón flotante para crear nuevo proyecto -->
    <div class="position-fixed bottom-0 end-0 p-4">
        <a href="{% url 'projects:project_create' %}" class="btn fab-gradient text-white rounded-circle shadow-inclusive-lg d-flex align-items-center justify-content-center" style="width: 4rem; height: 4rem;" title="Crear Nuevo Proyecto">
            <i class="fas fa-plus fs-4"></i>
        </a>
    </div>
</div>
</div>

<script>
// Función para mostrar/ocultar filtros (disponible globalmente)
function toggleFilters() {
    console.log('toggleFilters ejecutada');
    const filtersContainer = document.getElementById('filtersContainer');
    const toggleText = document.getElementById('toggleText');
    const toggleIcon = document.getElementById('toggleIcon');
    
    if (filtersContainer.style.display === 'none' || filtersContainer.style.display === '') {
        filtersContainer.style.display = 'block';
        toggleText.textContent = 'Ocultar Filtros Avanzados';
        toggleIcon.className = 'fas fa-chevron-up ms-2';
    } else {
        filtersContainer.style.display = 'none';
        toggleText.textContent = 'Mostrar Filtros Avanzados';
        toggleIcon.className = 'fas fa-chevron-down ms-2';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Función para aplicar filtros automáticamente
    function autoApplyFilters() {
        const form = document.getElementById('filtersForm');
        const formData = new FormData(form);
        const params = new URLSearchParams();
        
        for (let [key, value] of formData.entries()) {
            if (value && value.trim() !== '') {
                params.append(key, value);
            }
        }
        
        const url = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.location.href = url;
    }
    
    // Aplicar filtros automáticamente al cambiar selects
    document.querySelectorAll('select').forEach(select => {
        select.addEventListener('change', function() {
            setTimeout(autoApplyFilters, 300);
        });
    });
    
    // Aplicar filtros al presionar Enter
    document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"]').forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                autoApplyFilters();
            }
        });
    });
    
    // Aplicar filtros al perder el foco
    document.querySelectorAll('input[type="number"], input[type="date"]').forEach(input => {
        input.addEventListener('blur', function() {
            if (this.value && this.value.trim() !== '') {
                setTimeout(autoApplyFilters, 500);
            }
        });
    });
    
    // Efectos hover para las cards
    document.querySelectorAll('.project-card-hover').forEach((card, index) => {
        card.style.animationDelay = `${index * 100}ms`;
        
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-8px) scale(1.02)';
            this.style.boxShadow = '0 15px 35px rgba(0,0,0,0.15)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
            this.style.boxShadow = '';
        });
    });
    
    // Formatear presupuestos en las cards con puntos cada 3 cifras
    document.querySelectorAll('[data-budget]').forEach(element => {
        const budget = parseFloat(element.getAttribute('data-budget'));
        if (budget && budget > 0) {
            const formatted = budget.toLocaleString('es-CO', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
            element.textContent = '$' + formatted;
        }
    });
    
    // Toggle para filtros avanzados
    const toggleAdvancedBtn = document.getElementById('toggleAdvancedFilters');
    const advancedFilters = document.getElementById('advancedFilters');
    const toggleAdvancedText = document.getElementById('toggleAdvancedText');
    const toggleAdvancedIcon = document.getElementById('toggleAdvancedIcon');
    
    if (toggleAdvancedBtn && advancedFilters) {
        toggleAdvancedBtn.addEventListener('click', function() {
            if (advancedFilters.style.display === 'none' || advancedFilters.style.display === '') {
                advancedFilters.style.display = 'block';
                toggleAdvancedText.textContent = 'Ocultar Filtros Avanzados';
                toggleAdvancedIcon.className = 'fas fa-chevron-up ms-2';
            } else {
                advancedFilters.style.display = 'none';
                toggleAdvancedText.textContent = 'Mostrar Filtros Avanzados';
                toggleAdvancedIcon.className = 'fas fa-chevron-down ms-2';
            }
        });
    }
    
    // Auto-submit del formulario al cambiar cualquier filtro
    const form = document.getElementById('filtersForm');
    if (form) {
        // Auto-submit al cambiar selects
        form.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', function() {
                setTimeout(() => form.submit(), 300);
            });
        });
        
        // Auto-submit al presionar Enter en campos de texto
        form.querySelectorAll('input[type="text"]').forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    form.submit();
                }
            });
        });
        
        // Auto-submit al perder el foco en campos numéricos, de fecha y presupuesto
        form.querySelectorAll('input[type="number"], input[type="date"], .budget-input').forEach(input => {
            input.addEventListener('blur', function() {
                if (this.value && this.value.trim() !== '') {
                    setTimeout(() => form.submit(), 500);
            }
        });
    });
    
    // Validación de fechas
        const fechaDesde = form.querySelector('input[name="fecha_desde"]');
        const fechaHasta = form.querySelector('input[name="fecha_hasta"]');
    
    if (fechaDesde && fechaHasta) {
        fechaDesde.addEventListener('change', function() {
            fechaHasta.min = this.value;
        });
        
        fechaHasta.addEventListener('change', function() {
            fechaDesde.max = this.value;
        });
        }
    }

    // Mostrar filtros automáticamente si hay filtros activos
    function autoShowAdvancedFilters() {
        const advancedFilters = document.getElementById('advancedFilters');
        const toggleAdvancedText = document.getElementById('toggleAdvancedText');
        const toggleAdvancedIcon = document.getElementById('toggleAdvancedIcon');
        
        const urlParams = new URLSearchParams(window.location.search);
        const hasAdvancedFilters = Array.from(urlParams.entries()).some(([key, value]) => 
            value && value.trim() !== '' && 
            ['trabajadores', 'creador', 'fecha_desde', 'fecha_hasta', 'ubicacion', 'presupuesto_min', 'presupuesto_max'].includes(key)
        );
        
        if (hasAdvancedFilters && advancedFilters) {
            advancedFilters.style.display = 'block';
            toggleAdvancedText.textContent = 'Ocultar Filtros Avanzados';
            toggleAdvancedIcon.className = 'fas fa-chevron-up ms-2';
        }
    }

    // Ejecutar auto-show al cargar la página
    autoShowAdvancedFilters();
    
    // Formateo de campos de presupuesto con puntos cada 3 cifras
    function formatBudgetInput(input) {
        let value = input.value.replace(/[^\d]/g, ''); // Solo números
        if (value && value.length > 0) {
            try {
                // Formatear con puntos cada 3 cifras
                const number = parseInt(value);
                if (!isNaN(number)) {
                    const formatted = number.toLocaleString('es-CO');
                    input.value = formatted;
                }
            } catch (e) {
                console.log('Error formateando número:', e);
            }
        }
    }
    
    // Aplicar formateo a campos de presupuesto
    document.querySelectorAll('.budget-input').forEach(input => {
        // Formatear al escribir
        input.addEventListener('input', function() {
            formatBudgetInput(this);
        });
        
        // Formatear al cargar la página
        if (this.value) {
            formatBudgetInput(this);
        }
    });
    
    // Limpiar puntos antes de enviar el formulario
    form.addEventListener('submit', function(e) {
        document.querySelectorAll('.budget-input').forEach(input => {
            if (input.value) {
                // Remover puntos y enviar solo números
                input.value = input.value.replace(/\./g, '');
            }
        });
    });
});
</script>
{% endblock %}
