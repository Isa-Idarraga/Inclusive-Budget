{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'C:\Users\ASUS\Downloads\InclusiveBudgetProject\Inclusive-Budget\static\styles.css' %}">

<div class="container py-5" style="max-width: 950px;">
  <h2 class="fw-bold mb-4 text-center">Asistente de Presupuestos</h2>

  <div id="chat-box" class="chat-box p-4 border rounded-4 bg-light mb-3 shadow-sm"></div>

  <form id="chat-form" class="d-flex gap-2">
    <input 
      type="text" 
      id="user-input" 
      class="form-control"
      placeholder="Escribe tu mensaje..." 
      required
    >
    <button type="submit" class="btn btn-dark px-4">Enviar</button>
  </form>
</div>

<script>
let conversationId = null;

document.getElementById("chat-form").addEventListener("submit", async function(e) {
  e.preventDefault();

  const input = document.getElementById("user-input");
  const message = input.value.trim();
  if (!message) return;

  appendMessage("user", message);
  input.value = "";
  appendTyping();

  try {
    const response = await fetch("{% url 'chatbot:chat_api' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        message: message,
        conversation_id: conversationId
      })
    });

    const data = await response.json();
    removeTyping();

    if (data.success && data.messages) {
      conversationId = data.conversation_id;

      // Evita duplicados (solo muestra respuestas del bot)
      data.messages
        .filter(msg => msg.role === "assistant")
        .forEach(msg => appendMessage("assistant", msg.content));
    } else {
      appendMessage("assistant", "No se pudo procesar tu mensaje.");
    }

  } catch (error) {
    removeTyping();
    appendMessage("assistant", "⚠️ Error al conectar con el servidor.");
  }
});

function appendMessage(role, content) {
  const chatBox = document.getElementById("chat-box");
  const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const isUser = role === "user";
  const bubbleColor = isUser ? "bg-primary text-white" : "bg-white border";

  const html = `
    <div class="d-flex ${isUser ? 'justify-content-end' : 'justify-content-start'} mb-3">
      <div class="p-3 rounded-4 ${bubbleColor}" style="max-width: 75%;">
        <div>${content}</div>
        <div class="text-muted small mt-1">${timestamp}</div>
      </div>
    </div>
  `;
  chatBox.insertAdjacentHTML("beforeend", html);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function appendTyping() {
  const chatBox = document.getElementById("chat-box");
  const typingHTML = `
    <div id="typing-indicator" class="d-flex align-items-center mb-2">
      <div class="bg-white border rounded-4 px-3 py-2">
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      </div>
    </div>
  `;
  chatBox.insertAdjacentHTML("beforeend", typingHTML);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function removeTyping() {
  const typing = document.getElementById("typing-indicator");
  if (typing) typing.remove();
}
</script>
{% endblock %}
