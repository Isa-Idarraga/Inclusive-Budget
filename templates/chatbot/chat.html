{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'C:\Users\ASUS\Downloads\InclusiveBudgetProject\Inclusive-Budget\static\styles.css' %}">

<div class="container py-5" style="max-width: 950px;">
  <h2 class="fw-bold mb-4 text-center">Asistente de Presupuestos</h2>

  <div id="chat-box" class="chat-box p-4 border rounded-4 bg-light mb-3 shadow-sm">
    <div class="text-muted small mb-3 text-center">
      üí¨ Escribe <b>"presupuesto con IA"</b> para iniciar uno nuevo.<br>
      ‚õî Escribe <b>‚Äúcancelar‚Äù</b> para detenerlo.
    </div>
  </div>

  <form id="chat-form" class="d-flex gap-2">
    <input 
      type="text" 
      id="user-input" 
      class="form-control"
      placeholder="Escribe tu mensaje..." 
      required
    >
    <button type="submit" class="btn btn-dark px-4">Enviar</button>
  </form>
</div>

<script>
let conversationId = null;

document.getElementById("chat-form").addEventListener("submit", async function(e) {
  e.preventDefault();

  const input = document.getElementById("user-input");
  const message = input.value.trim();
  if (!message) return;

  appendMessage("user", message);
  input.value = "";
  appendTyping();

  try {
    const response = await fetch("{% url 'chatbot:chat_api' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        message: message,
        conversation_id: conversationId
      })
    });

    const data = await response.json();
    removeTyping();

    if (data.success && data.messages) {
      conversationId = data.conversation_id;
      data.messages.forEach(msg => appendMessage(msg.role, msg.content));

      // üîπ Si hay opciones (choices del formulario), las mostramos como botones
      if (data.options && data.options.length > 0) {
        appendOptions(data.options);
      }
    } else {
      appendMessage("assistant", "‚ö†Ô∏è No se pudo procesar tu mensaje.");
    }

  } catch (error) {
    removeTyping();
    appendMessage("assistant", "‚ö†Ô∏è Error al conectar con el servidor.");
  }
});

function appendMessage(role, content) {
  const chatBox = document.getElementById("chat-box");
  const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const isUser = role === "user";
  const bubbleColor = isUser ? "bg-primary text-white" : "bg-white border";

  const html = `
    <div class="d-flex ${isUser ? 'justify-content-end' : 'justify-content-start'} mb-3">
      <div class="p-3 rounded-4 ${bubbleColor}" style="max-width: 75%;">
        <div>${content}</div>
        <div class="text-muted small mt-1">${timestamp}</div>
      </div>
    </div>
  `;
  chatBox.insertAdjacentHTML("beforeend", html);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function appendTyping() {
  const chatBox = document.getElementById("chat-box");
  const typingHTML = `
    <div id="typing-indicator" class="d-flex align-items-center mb-2">
      <div class="bg-white border rounded-4 px-3 py-2">
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      </div>
    </div>
  `;
  chatBox.insertAdjacentHTML("beforeend", typingHTML);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function removeTyping() {
  const typing = document.getElementById("typing-indicator");
  if (typing) typing.remove();
}

// üîπ Mostrar opciones como botones debajo del mensaje
function appendOptions(options) {
  const chatBox = document.getElementById("chat-box");
  const container = document.createElement("div");
  container.classList.add("d-flex", "flex-wrap", "gap-2", "mb-3");

  options.forEach(opt => {
    const btn = document.createElement("button");
    btn.classList.add("btn", "btn-outline-dark", "btn-sm", "rounded-pill");
    btn.textContent = opt;
    btn.onclick = () => {
      document.getElementById("user-input").value = opt;
      document.getElementById("chat-form").dispatchEvent(new Event("submit"));
      container.remove(); // quitar los botones al elegir
    };
    container.appendChild(btn);
  });

  chatBox.appendChild(container);
  chatBox.scrollTop = chatBox.scrollHeight;
}
</script>
{% endblock %}
